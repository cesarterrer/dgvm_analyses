---
title: "Root shoot ratio in DGVMs"
author: "Benjamin D. Stocker"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
# output:
#   pdf_document:
#     toc: true
#     toc_depth: 2
---

```{r include=FALSE}
library(dplyr)
library(purrr)
library(tidyr)
library(ggplot2)
library(readr)
library(stringr)

availvars <- read_csv( "./availvars_trendy_v8_S2.csv" )
filnams <- read_csv( "filnams_trendy_v8_S2.csv" )
varnams <- read_csv( "varnams_trendy_v8_S2.csv" )
# modeltype <- read_csv( "modeltype_trendy_v8.csv" ) %>% 
  # mutate( col=ifelse( cn==1, "royalblue3", "springgreen3" ) )
```

## Process TRENDY v8 files

From downloaded TRENDY outputs (here, simulation S2: only CO2 is changing), get global fields of mass fractions $M_R, M_F, M_W$ and root:shoot ratio $(M_F + M_W)/M_R$ as the mean over several years. This is implemented in a Bash script.

### Wood mass fraction

Determine for which models we have all the files (cWood and cVeg) to calculate wood mass fractions and create system command.
```{r}
modls_mw <- availvars %>% 
  filter(cWood==1 & cVeg==1) %>% 
  pull(modl)

df <- filnams %>% 
  filter(modl %in% modls_mw) %>% 
  select(modl, filn_cWood = cWood, filn_cVeg = cVeg) %>% 
  left_join(
    varnams %>% 
      select(modl, varn_cWood = cWood, varn_cVeg = cVeg),
    by = "modl"
  ) %>% 
  mutate_at(vars(starts_with("filn_")), ~str_replace(., ".nc", "")) %>% 
  mutate(dir = paste0("/cluster/home/bestocke/data/trendy/v8/")) %>% 
  mutate(cmd = paste("./calc_mass_fraction.sh", filn_cWood, filn_cVeg, dir))
```

Execute function using CDO.
```{r}
out <- purrr::map(as.list(df %>% pull(cmd)), ~system(., intern = TRUE))
```

### Leaf mass fraction

Determine for which models we have all the files (cWood and cVeg) to calculate wood mass fractions and create system command.
```{r}
modls_ml <- availvars %>% 
  filter(cLeaf==1 & cVeg==1) %>% 
  pull(modl)

df <- filnams %>% 
  filter(modl %in% modls_ml) %>% 
  select(modl, filn_cLeaf = cLeaf, filn_cVeg = cVeg) %>% 
  left_join(
    varnams %>% 
      select(modl, varn_cLeaf = cLeaf, varn_cVeg = cVeg),
    by = "modl"
  ) %>% 
  mutate_at(vars(starts_with("filn_")), ~str_replace(., ".nc", "")) %>% 
  mutate(dir = paste0("/cluster/home/bestocke/data/trendy/v8/")) %>% 
  mutate(cmd = paste("./calc_mass_fraction.sh", filn_cLeaf, filn_cVeg, dir))
```

Execute function using CDO.
```{r}
out <- purrr::map(as.list(df %>% pull(cmd)), ~system(., intern = TRUE))
```

### Root mass fraction

Determine for which models we have all the files (cWood and cVeg) to calculate wood mass fractions and create system command.
```{r}
modls_mr <- availvars %>% 
  filter(cRoot==1 & cVeg==1) %>% 
  pull(modl)

df <- filnams %>% 
  filter(modl %in% modls_mr) %>% 
  select(modl, filn_cRoot = cRoot, filn_cVeg = cVeg) %>% 
  left_join(
    varnams %>% 
      select(modl, varn_cRoot = cRoot, varn_cVeg = cVeg),
    by = "modl"
  ) %>% 
  mutate_at(vars(starts_with("filn_")), ~str_replace(., ".nc", "")) %>% 
  mutate(dir = paste0("/cluster/home/bestocke/data/trendy/v8/")) %>% 
  mutate(cmd = paste("./calc_mass_fraction.sh", filn_cRoot, filn_cVeg, dir))
```

Execute function using CDO.
```{r}
out <- purrr::map(as.list(df %>% pull(cmd)), ~system(., intern = TRUE))
```

### Root:shoot ratio

The root:shoot ratio can be calculated in different ways.
$$
r_{RS} = \frac{M_R}{M_L + M_W} = \frac{C_R}{C-C_R} = \frac{C-C_L-C_W}{C_L + C_W}
$$
The first one, based on mass fractions, requires the same files to be available as the second one. Thus, it's actually just two ways. Let's determine which models provide enough information to calculate it based on the second or third option.

Second option:
```{r}
modls_II <- availvars %>% 
  filter(cRoot==1 & cVeg==1) %>% 
  pull(modl)
```

Third option:
```{r}
modls_III <- availvars %>% 
  filter(cLeaf==1 & cWood==1 & cVeg==1) %>% 
  pull(modl)
```

There is no model available for III but not for II:
```{r}
!(modls_III %in% modls_II)
!(modls_II %in% modls_III)
```
Hence, let's just do it with `modls_II`:
```{r}
df <- filnams %>% 
  filter(modl %in% modls_II) %>% 
  select(modl, filn_cRoot = cRoot, filn_cVeg = cVeg) %>% 
  left_join(
    varnams %>% 
      select(modl, varn_cRoot = cRoot, varn_cVeg = cVeg),
    by = "modl"
  ) %>% 
  mutate_at(vars(starts_with("filn_")), ~str_replace(., ".nc", "")) %>% 
  mutate(dir = paste0("/cluster/home/bestocke/data/trendy/v8/")) %>% 
  mutate(cmd = paste("./calc_rootshoot_ratio.sh", filn_cRoot, filn_cVeg, dir))
```

Execute function using CDO.
```{r}
out <- purrr::map(as.list(df %>% pull(cmd)), ~system(., intern = TRUE))
```
